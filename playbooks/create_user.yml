---
- name: Create client user and install generated SSH key
  hosts: all
  become: true
  vars:
    # Variables passed from Jenkins
    target_user: "{{ new_user }}"
    ssh_key_path: "{{ pubkey_file }}"
    
    # Ansible reads the content of the .pub file generated by Jenkins
    key_content: "{{ lookup('file', ssh_key_path) }}"

  tasks:
    - name: Ensure the 'readers' group exists
      group:
        name: readers
        state: present

    - name: Ensure user exists and is added to group
      user:
        name: "{{ target_user }}"
        comment: "Client User"
        groups: readers
        append: yes
        create_home: yes
        shell: /bin/bash
        state: present

    - name: Ensure .ssh directory exists
      file:
        path: "/home/{{ target_user }}/.ssh"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0700"

    - name: Install the generated Public Key
      authorized_key:
        user: "{{ target_user }}"
        key: "{{ key_content }}"
        state: present

    - name: Display Created User Info
      command: id "{{ target_user }}"
      register: idinfo
      changed_when: false

    - debug:
        var: idinfo.stdout
